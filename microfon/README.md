# Система обнаружения дронов

Данная система предназначена для обнаружения и локализации дронов с помощью звуковых сигналов, нейронной сети и визуализации результатов на интерактивной карте.

## Структура проекта

- `RasbaryPi2.py` - основной файл с нейронной сетью для классификации звуков и определения сектора обнаружения дрона
- `mic_sender.py` - скрипт для захвата аудио с микрофонов и передачи данных на сервер
- `locator_static/` - веб-интерфейс (фронтенд) для визуализации результатов
- `mic_startup.bat` - скрипт для автоматического запуска всех компонентов системы с микрофонами
- `startup.bat` - скрипт для запуска только сервера и веб-интерфейса (без микрофонов)
- `clap_startup.bat` - скрипт для запуска в демо-режиме с распознаванием хлопков
- `install_dependencies.bat` - скрипт для установки всех необходимых зависимостей
- `copy_model_files.bat` - скрипт для копирования файлов модели в нужные директории

## Требования

1. Python 3.7 или выше
2. Node.js и npm
3. Библиотеки Python:
   - pytorch
   - librosa
   - numpy
   - websockets
   - asyncio
   - scikit-learn
   - pyaudio (для работы с микрофонами)
   - tensorflow (для демо-режима с хлопками)

## Установка

Для установки всех необходимых зависимостей используйте скрипт `install_dependencies.bat`:

```
cd путь_к_проекту/kasatka/microfon
install_dependencies.bat
```

Скрипт установит все необходимые библиотеки Python и npm-пакеты для фронтенда.

### Подготовка файлов модели для демо-режима

Для работы демо-режима с распознаванием хлопков необходимы два файла:
- `soundclassifier_with_metadata.tflite` - модель TensorFlow Lite
- `labels.txt` - файл с метками классов

Эти файлы должны находиться в директории `kasatka/microfon/`. Для автоматического копирования файлов из корневой директории в нужное место выполните:

```
cd путь_к_проекту/kasatka/microfon
copy_model_files.bat
```

## Режимы работы

### Основной режим обнаружения дронов

В этом режиме система анализирует звуки, поступающие с микрофонов, и определяет наличие дрона в том или ином секторе. Для этого используется модель нейронной сети PyTorch, обученная на звуках дронов и фоновом шуме.

### Демо-режим с распознаванием хлопков

Данный режим предназначен для демонстрации работы системы без наличия дрона. Вместо звуков дронов система реагирует на хлопки и определяет сектор, откуда хлопок пришел. В этом режиме используется предварительно обученная TensorFlow модель для распознавания хлопков.

## Запуск системы

### Выбор режима через startup.bat

Самый простой способ запустить систему - использовать `startup.bat`:

1. Откройте командную строку
2. Перейдите в директорию проекта: `cd путь_к_проекту/kasatka/microfon`
3. Запустите скрипт: `startup.bat`
4. Выберите режим работы:
   - `1` - Обнаружение дронов (стандартный режим)
   - `2` - Демо-режим с распознаванием хлопков

### Автоматический запуск с микрофонами (режим дронов)

Для полного запуска системы с микрофонами в режиме обнаружения дронов используйте скрипт `mic_startup.bat`:

1. Откройте командную строку
2. Перейдите в директорию проекта: `cd путь_к_проекту/kasatka/microfon`
3. Запустите скрипт: `mic_startup.bat`
4. Следуйте инструкциям на экране:
   - Выберите индекс микрофона из списка
   - Выберите режим работы (реальные микрофоны или тестовые WAV-файлы)

### Запуск в демо-режиме с распознаванием хлопков

Для запуска системы в демо-режиме с распознаванием хлопков используйте скрипт `clap_startup.bat`:

1. Убедитесь, что файлы модели скопированы в нужную директорию (`copy_model_files.bat`)
2. Откройте командную строку
3. Перейдите в директорию проекта: `cd путь_к_проекту/kasatka/microfon`
4. Запустите скрипт: `clap_startup.bat`
5. Выберите индекс микрофона из списка
6. Сделайте хлопок рядом с микрофоном для проверки системы

### Ручной запуск компонентов

Если вам нужно запустить компоненты вручную:

#### Запуск бэкенда (нейронной сети)

Для стандартного режима:
```
cd путь_к_проекту/kasatka/microfon
python RasbaryPi2.py
```

Для демо-режима с хлопками:
```
cd путь_к_проекту/kasatka/microfon
python RasbaryPi2.py --mode clap
```

#### Запуск клиентов микрофонов

Посмотреть доступные аудиоустройства:
```
python mic_sender.py --list
```

Запустить клиент для микрофона 1:
```
python mic_sender.py --mic 1 --device 0
```

Для тестирования с WAV-файлом:
```
python mic_sender.py --mic 1 --test путь/к/файлу.wav
```

#### Запуск фронтенда

```
cd путь_к_проекту/kasatka/microfon/locator_static
npm install  # только при первом запуске
npm start
```

## Тестирование с WAV-файлами

Если у вас нет 4 микрофонов, вы можете использовать WAV-файлы для тестирования:

1. Создайте директорию `test` в папке проекта
2. Поместите туда WAV-файлы с названиями:
   - `mic1.wav`
   - `mic2.wav`
   - `mic3.wav`
   - `mic4.wav`
3. Запустите `mic_startup.bat` и выберите опцию использования тестовых файлов

## Принцип работы

1. Клиенты микрофонов захватывают аудиоданные и отправляют на сервер
2. Нейросеть анализирует звуковые данные и определяет наличие дрона (или хлопка в демо-режиме)
3. На основе разницы в интенсивности сигнала с разных микрофонов определяется сектор обнаружения
4. Информация о секторе передается по WebSocket на фронтенд
5. Фронтенд визуализирует активный сектор обнаружения

## Устранение неполадок

1. Если фронтенд не получает данные от бэкенда:
   - Убедитесь, что WebSocket сервер запущен и работает на порту 8765
   - Проверьте подключение к сети
   - Перезапустите все компоненты системы

2. Если нейронная сеть не запускается:
   - Убедитесь, что все необходимые библиотеки Python установлены
   - Проверьте наличие файла модели `sound_classifier_model.pth` (для режима дронов)
   - Проверьте наличие файлов `soundclassifier_with_metadata.tflite` и `labels.txt` в директории `kasatka/microfon` (для демо-режима)

3. Если возникают проблемы с микрофонами:
   - Проверьте, что PyAudio установлен (`pip install pyaudio`)
   - На Windows может потребоваться установить Microsoft Visual C++ Build Tools
   - Попробуйте использовать другой индекс микрофона
   - Используйте режим тестирования с WAV-файлами 

4. Если демо-режим с хлопками не работает:
   - Убедитесь, что установлен TensorFlow (`pip install tensorflow`)
   - Проверьте наличие файлов модели - запустите `copy_model_files.bat` для копирования файлов в нужное место
   - Убедитесь, что файлы `soundclassifier_with_metadata.tflite` и `labels.txt` присутствуют в директории `kasatka/microfon`
   - Увеличьте громкость хлопка или приблизьтесь к микрофону 